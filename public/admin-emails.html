<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <title>Email Admin | The Grasshopper</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #f5f5f5; color: #333; min-height: 100vh; }

        .login-screen {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 2rem;
        }
        .login-box {
            background: white;
            padding: 2.5rem;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            max-width: 400px;
            width: 100%;
            text-align: center;
        }
        .login-box h1 { font-size: 1.5rem; margin-bottom: 0.5rem; }
        .login-box p { color: #888; margin-bottom: 1.5rem; font-size: 0.9rem; }
        .login-box input {
            width: 100%;
            padding: 0.875rem 1rem;
            font-size: 1rem;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            outline: none;
            margin-bottom: 1rem;
        }
        .login-box input:focus { border-color: #6B5B7A; }
        .login-box button {
            width: 100%;
            padding: 0.875rem;
            font-size: 0.9375rem;
            font-weight: 600;
            color: white;
            background: #2D2D2D;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }
        .login-box button:hover { background: #6B5B7A; }
        .login-error { color: #e53; font-size: 0.875rem; margin-top: 0.5rem; display: none; }

        .admin-panel { display: none; padding: 2rem; max-width: 900px; margin: 0 auto; }
        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            gap: 1rem;
        }
        .admin-header h1 { font-size: 1.5rem; }
        .admin-actions { display: flex; gap: 0.75rem; }
        .btn {
            padding: 0.625rem 1.25rem;
            font-size: 0.875rem;
            font-weight: 600;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        .btn-primary { background: #2D2D2D; color: white; }
        .btn-primary:hover { background: #6B5B7A; }
        .btn-outline { background: white; color: #333; border: 2px solid #e0e0e0; }
        .btn-outline:hover { border-color: #6B5B7A; color: #6B5B7A; }

        .stats {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
        }
        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            flex: 1;
        }
        .stat-card .number { font-size: 2rem; font-weight: 700; color: #6B5B7A; }
        .stat-card .label { font-size: 0.875rem; color: #888; margin-top: 0.25rem; }

        .email-table-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            overflow: hidden;
        }
        table { width: 100%; border-collapse: collapse; }
        th { background: #f9f9f9; padding: 0.875rem 1.25rem; text-align: left; font-size: 0.8125rem; text-transform: uppercase; letter-spacing: 0.05em; color: #888; border-bottom: 2px solid #eee; }
        td { padding: 0.875rem 1.25rem; border-bottom: 1px solid #f0f0f0; font-size: 0.9375rem; }
        tr:hover td { background: #fafafa; }

        .loading { text-align: center; padding: 3rem; color: #888; }
        .empty { text-align: center; padding: 3rem; color: #888; }
    </style>
</head>
<body>
    <div class="login-screen" id="loginScreen">
        <div class="login-box">
            <h1>The Grasshopper</h1>
            <p>Enter admin key to view newsletter emails</p>
            <input type="password" id="adminKey" placeholder="Admin key" onkeydown="if(event.key==='Enter') doLogin()">
            <button onclick="doLogin()">Sign In</button>
            <p class="login-error" id="loginError">Invalid admin key. Please try again.</p>
        </div>
    </div>

    <div class="admin-panel" id="adminPanel">
        <div class="admin-header">
            <h1>Newsletter Emails</h1>
            <div class="admin-actions">
                <button class="btn btn-outline" onclick="loadEmails()">Refresh</button>
                <button class="btn btn-primary" onclick="downloadCSV()">Download CSV for Excel</button>
            </div>
        </div>
        <div class="stats">
            <div class="stat-card">
                <div class="number" id="totalEmails">--</div>
                <div class="label">Total Subscribers</div>
            </div>
        </div>
        <div class="email-table-container">
            <table>
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Email Address</th>
                        <th>Date Subscribed</th>
                    </tr>
                </thead>
                <tbody id="emailTableBody">
                    <tr><td colspan="3" class="loading">Enter admin key to load emails...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        let adminKey = '';

        function doLogin() {
            adminKey = document.getElementById('adminKey').value.trim();
            if (!adminKey) return;

            document.getElementById('loginError').style.display = 'none';

            // Try fetching emails with the key to validate
            fetch('/api/export-emails', { headers: { 'X-Admin-Key': adminKey } })
                .then(res => {
                    if (res.status === 401) {
                        document.getElementById('loginError').style.display = 'block';
                        return null;
                    }
                    return res.json();
                })
                .then(data => {
                    if (!data) return;
                    document.getElementById('loginScreen').style.display = 'none';
                    document.getElementById('adminPanel').style.display = 'block';
                    displayEmails(data);
                })
                .catch(() => {
                    document.getElementById('loginError').textContent = 'Connection error. Check your environment variables.';
                    document.getElementById('loginError').style.display = 'block';
                });
        }

        function loadEmails() {
            const tbody = document.getElementById('emailTableBody');
            tbody.innerHTML = '<tr><td colspan="3" class="loading">Loading...</td></tr>';

            fetch('/api/export-emails', { headers: { 'X-Admin-Key': adminKey } })
                .then(res => res.json())
                .then(data => displayEmails(data))
                .catch(() => {
                    tbody.innerHTML = '<tr><td colspan="3" class="loading">Failed to load emails.</td></tr>';
                });
        }

        function displayEmails(data) {
            const tbody = document.getElementById('emailTableBody');
            document.getElementById('totalEmails').textContent = data.total || 0;

            if (!data.emails || data.emails.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" class="empty">No email subscribers yet.</td></tr>';
                return;
            }

            tbody.innerHTML = data.emails.map((item, i) => {
                const date = item.date ? new Date(item.date).toLocaleDateString('en-US', {
                    year: 'numeric', month: 'short', day: 'numeric'
                }) : '--';
                return `<tr>
                    <td>${i + 1}</td>
                    <td>${escapeHtml(item.email)}</td>
                    <td>${date}</td>
                </tr>`;
            }).join('');
        }

        function downloadCSV() {
            fetch('/api/export-emails?format=csv', { headers: { 'X-Admin-Key': adminKey } })
                .then(res => res.blob())
                .then(blob => {
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'newsletter-emails.csv';
                    a.click();
                    URL.revokeObjectURL(url);
                });
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
